import React,{useState,useContext, useEffect} from 'react'
import moment from 'moment'
import useFetch from 'hooks/useFetch'
import {CurrentUserContext} from 'contexts/currentUser'
import CommentsList from 'components/commentsList'

const Comments = ({slug}) => {
  const apiUrl = `/articles/${slug}/comments`
  const [{ response },doFetch] = useFetch(apiUrl)
  const [currentUserState] = useContext(CurrentUserContext);
  const commentId = Math.floor(Math.random() * 1000000)
  const createdAt = moment().format(); 
  // console.log(user);
  const [commentBody, setCommentBody] = useState('');
  const handleSubmit = (e) => {
    const { currentUser: { bio, following, image, username } } = currentUserState
    const user = { bio, following, image, username }
    const comment = { id: commentId, createdAt, updatedAt: createdAt, body: commentBody, author: user }
    e.preventDefault()
    doFetch({
      method: 'post',
      data: {
        comment
      }
    })
    setCommentBody('')
  }

  return (
    <>
      <form className="card comment-form ng-untouched ng-pristine ng-valid" onSubmit={handleSubmit}>
        <fieldset>
          <div className="card-block">
            <textarea className="form-control ng-valid ng-untouched ng-pristine" placeholder="Write a comment..." rows="3" onChange={e=> setCommentBody(e.target.value)} value={commentBody}></textarea>
          </div>
          <div className="card-footer">
            <img className="comment-author-img" src="https://static.productionready.io/images/smiley-cyrus.jpg"/>
            <button className="btn btn-sm btn-primary" type="submit"> Post Comment </button>
          </div>
        </fieldset>
    </form>
      <CommentsList slug={slug} newComment={response}/>	
    </>
  )
}

export default Comments
